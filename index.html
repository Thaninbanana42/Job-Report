<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Student Attendance Check</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css">

  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.6.0.js"></script>

  <!-- Sweet Alert -->
  <script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <!-- Loading Overlay -->
  <script src="https://cdn.jsdelivr.net/npm/gasparesganga-jquery-loading-overlay@2.1.7/dist/loadingoverlay.min.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Thai');

    * {
      box-sizing: border-box;
      font-family: 'Noto Sans Thai', sans-serif;
    }

    body {
      display: flex;
      align-items: center;
      justify-content: flex-start;
      min-height: 100vh;
      background: rgb(252, 233, 233);
      background: linear-gradient(0deg, rgba(252, 233, 233, 1) 0%, rgba(224, 244, 241, 1) 26%, rgba(255, 255, 255, 1) 71%);
      -webkit-background-size: cover;
      -moz-background-size: cover;
      -o-background-size: cover;
      flex-direction: column;
    }

    .list {
      background-color: #ffffff;
      padding: 1.8em 1.2em;
      box-shadow: rgba(0, 0, 0, 0.24) 0px 3px 8px;
      border-radius: 0.6em;
    }

    footer {
      margin-top: 10px;
      background-color: #000;
      width: 100%;
      padding: 2px;
      position: fixed;
      bottom: 0;
    }

    footer p,
    footer a {
      text-decoration: none;
      margin: 0;
    }

    footer .fa {
      color: #fff740;
    }
  </style>
</head>
<body>
  <center class="mb-4">
    <img src="https://lh3.googleusercontent.com/d/1ZMI9FTcErAj1N8vh0viy3rAPnxZ7Zsky" class="mt-4" style="width:200px; height:auto; padding-bottom: 10px;">
    <h2>Student Attendance Apps</h2>
    <h5 class="text-center text-danger">สื่อ และนวัตกรรมครูสิทธิชาติ สิทธิ</h5>
  </center>

  <main class="container">
    <div class="container list">
      <div class="d-flex justify-content-center mb-3">
        <button id="check-all-present" class="btn btn-primary me-2">มาทั้งหมด</button>
        <button id="check-all-absent" class="btn btn-secondary">ขาดทั้งหมด</button>
        <button id="check-all-leave" class="btn btn-warning ms-2">ลาทั้งหมด</button>
        <button id="check-all-late" class="btn btn-danger ms-2">สายทั้งหมด</button>
      </div>
      <!-- <form id="attendance-form" class="mt-4">
        <div class="row mb-3">
          <label class="col-form-label">รายชื่อนักเรียน:</label>
        </div>
        <div id="student-list"></div>
        <center><button type="submit" class="btn btn-primary mt-3">บันทึกข้อมูล</button></center>
      </form> -->

<form id="attendance-form" class="mt-4">
  <div class="row mb-3">
    <label for="class-period" class="form-label">คาบเรียน</label>
    <select id="class-period" class="form-select" required>
      <option value="">-- เลือกคาบเรียน --</option>
      <option value="คาบที่ 1">คาบที่ 1</option>
      <option value="คาบที่ 2">คาบที่ 2</option>
      <option value="คาบที่ 3">คาบที่ 3</option>
      <option value="คาบที่ 4">คาบที่ 4</option>
      <option value="คาบที่ 5">คาบที่ 5</option>
      <option value="คาบที่ 6">คาบที่ 6</option>
      <option value="คาบที่ 7">คาบที่ 7</option>
      <option value="คาบที่ 8">คาบที่ 8</option>
    </select>
  </div>

  <div class="row mb-3">
    <label class="col-form-label">รายชื่อนักเรียน:</label>
  </div>
  <div id="student-list"></div>
        
  <div class="row mb-3">
    <label for="note" class="form-label">หมายเหตุ</label>
    <textarea id="note" class="form-control" rows="2" placeholder="หมายเหตุอื่นๆ (ถ้ามี)"></textarea>
  </div>
  
<div class="row mb-3">
  <label for="imageFile" class="form-label">อัปโหลดรูป (ไม่บังคับ)</label>
  <input type="file" id="imageFile" class="form-control" accept="image/*">
  <div id="upload-status" class="mt-2 text-primary" style="display:none;">กำลังอัปโหลด...</div>
  <div id="upload-preview" class="mt-2" style="display:none;">
    <img id="preview-image" src="" style="max-width: 150px; border:1px solid #ddd; border-radius:6px;">
  </div>
  <!-- hidden to store URL -->
  <input type="hidden" id="imageUrl">
</div>

  <center><button type="submit" class="btn btn-primary mt-3">บันทึกข้อมูล</button></center>
</form>

      
      <center><button id="send-summary" class="btn btn-success mt-3">แชร์ Flex message</button></center>
    </div>
  </main>

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <script>
    let attendanceRecords = [];
    const studentListUrl = 'https://opensheet.elk.sh/1FMvp7FBBBWxD-tE2e0Uh3_syhlAUXpBryPjMQmLW9Q4/Name'; // 1. แก้ ID SHEET และ ชีท
let uploadedImageUrl = ''; // keep it global so sendSummary can use it

// Image upload functionality using ImgBB API
async function uploadImageToImgBB(file) {
  const API_KEY = '2b5abf2e1e7a744ab8c232c015014187'; // 2. สถานที่เก็บรูป เว็บ ImgBB

  const base64 = await new Promise((resolve) => {
    const reader = new FileReader();
    reader.onload = () => {
      const base64String = reader.result.split(',')[1];
      resolve(base64String);
    };
    reader.readAsDataURL(file);
  });

  const formData = new FormData();
  formData.append('image', base64);

  const response = await fetch(`https://api.imgbb.com/1/upload?key=${API_KEY}`, {
    method: 'POST',
    body: formData
  });

  if (!response.ok) {
    throw new Error('Upload failed: ' + response.status);
  }

  const result = await response.json();
  if (result.success && result.data && result.data.url) {
    return result.data.url;
  } else {
    throw new Error('Invalid response from ImgBB API');
  }
}

// handle file input
document.addEventListener('DOMContentLoaded', () => {
  const fileInput = document.getElementById('imageFile');
  if (!fileInput) return;

  fileInput.addEventListener('change', async (e) => {
    const file = e.target.files[0];
    if (!file) return;

    const uploadStatus = document.getElementById('upload-status');
    const uploadPreview = document.getElementById('upload-preview');
    const previewImage = document.getElementById('preview-image');
    const imageUrlInput = document.getElementById('imageUrl');

    try {
      uploadStatus.style.display = 'block';
      uploadPreview.style.display = 'none';

      const imageUrl = await uploadImageToImgBB(file);

      uploadedImageUrl = imageUrl;           // <-- save for later
      imageUrlInput.value = imageUrl;        // <-- in case you need it in form
      previewImage.src = imageUrl;

      uploadStatus.style.display = 'none';
      uploadPreview.style.display = 'block';

      Swal.fire('Success', 'Image uploaded to ImgBB!', 'success');
    } catch (err) {
      uploadStatus.style.display = 'none';
      uploadPreview.style.display = 'none';
      uploadedImageUrl = '';
      Swal.fire('Error', err.message, 'error');
      e.target.value = '';
    }
  });
});

    window.onload = function() {
      liff.init({ liffId: '2007333975-Qn6Py3q0' })  // แก้ไข Liff จาก บอทที่เขียนว่า Login
        .then(() => {
          if (!liff.isLoggedIn()) {
            liff.login();
          } else {
            console.log('LIFF initialized');
            fetchStudentList();
            document.getElementById('attendance-form').addEventListener('submit', addAttendanceRecord);
            document.getElementById('send-summary').addEventListener('click', sendSummary);
            document.getElementById('check-all-present').addEventListener('click', () => checkAll('มา'));
            document.getElementById('check-all-absent').addEventListener('click', () => checkAll('ขาด'));
            document.getElementById('check-all-leave').addEventListener('click', () => checkAll('ลา'));
            document.getElementById('check-all-late').addEventListener('click', () => checkAll('สาย'));
          }
        })
        .catch((err) => {
          console.error('Error initializing LIFF: ', err);
          Swal.fire('Error', 'Failed to initialize LIFF: ' + err, 'error');
        });
    };

    function fetchStudentList() {
      fetch(studentListUrl)
        .then(response => response.json())
        .then(data => generateStudentList(data))
        .catch(error => {
          console.error('Error fetching student list: ', error);
          Swal.fire('Error', 'Failed to fetch student list: ' + error, 'error');
        });
    }

    function generateStudentList(students) {
      const studentList = document.getElementById('student-list');
      students.forEach(student => {
        const studentRow = document.createElement('div');
        studentRow.className = 'row mb-3';
        studentRow.innerHTML = `
          <div class="col-6">
            <label class="form-label">${student['เลขที่']}. ${student['รายชื่อนักเรียน']}</label>
          </div>
          <div class="col-1">
            <label>
              <input type="radio" name="student${student['เลขที่']}" value="มา" required> มา
            </label>
          </div>
          <div class="col-1">
            <label>
              <input type="radio" name="student${student['เลขที่']}" value="ขาด" required> ขาด
            </label>
          </div>
          <div class="col-1">
            <label>
              <input type="radio" name="student${student['เลขที่']}" value="ลา" required> ลา
            </label>
          </div>
          <div class="col-1">
            <label>
              <input type="radio" name="student${student['เลขที่']}" value="สาย" required> สาย
            </label>
          </div>
        `;
        studentList.appendChild(studentRow);
      });
    }
    
    function checkAll(status) {
      const studentList = document.getElementById('student-list');
      const radios = studentList.querySelectorAll(`input[value="${status}"]`);
      radios.forEach(radio => radio.checked = true);
    }

function addAttendanceRecord(event) {
  event.preventDefault();
  attendanceRecords = [];
  let allSelected = true;

  const period = document.getElementById('class-period').value;
  const note = document.getElementById('note').value || ''; // can be empty

  if (!period) {
    Swal.fire('Error', 'กรุณาเลือกระบุคาบเรียนก่อนบันทึกครับ', 'error');
    return;
  }

  const studentList = document.getElementById('student-list');
  const studentRows = studentList.querySelectorAll('.row');

  studentRows.forEach(row => {
    const studentName = row.querySelector('.form-label').innerText.replace(/:$/, '');
    const studentStatusElement = row.querySelector('input:checked');

    if (studentStatusElement) {
      const studentStatus = studentStatusElement.value;
      // attach period and note to each record
      attendanceRecords.push({
        name: studentName,
        status: studentStatus,
        period: period,
        note: note
      });
    } else {
      allSelected = false;
    }
  });

  if (allSelected) {
    saveToSheet(attendanceRecords);
  } else {
    Swal.fire('Error', 'Please fill in the attendance status for all students!', 'error');
  }
}


    function saveToSheet(records) {
      $.LoadingOverlay("show");

      const url = 'https://script.google.com/macros/s/AKfycbyfGTwYZ65id7HbS8kbSpZ9pzkuv9eOp-hA65ph7Cm_zb0W669x9DAtxBNpELLsJo4SBg/exec'; // Replace with your web app URL

      $.post(url, JSON.stringify(records), function(data) {
        $.LoadingOverlay("hide");
        if (data.status === 'success') {
          Swal.fire('Success', 'Attendance data saved to sheet!', 'success');
        } else {
          Swal.fire('Error', 'Failed to save attendance data!', 'error');
        }
      }).fail(function() {
        $.LoadingOverlay("hide");
        Swal.fire('Error', 'Failed to connect to the server!', 'error');
      });
    }

    function formatThaiDate(date) {
      const months = [
        'มกราคม', 'กุมภาพันธ์', 'มีนาคม', 'เมษายน', 'พฤษภาคม', 'มิถุนายน',
        'กรกฎาคม', 'สิงหาคม', 'กันยายน', 'ตุลาคม', 'พฤศจิกายน', 'ธันวาคม'
      ];
      const day = date.getDate();
      const month = months[date.getMonth()];
      const year = date.getFullYear() + 543;
      return `${day} ${month} ${year}`;
    }

function sendSummary() {
  if (attendanceRecords.length === 0) {
    Swal.fire('Error', 'No attendance records to send!', 'error');
    return;
  }

  const presentCount = attendanceRecords.filter(record => record.status === 'มา').length;
  const absentCount = attendanceRecords.filter(record => record.status === 'ขาด').length;
  const leaveCount = attendanceRecords.filter(record => record.status === 'ลา').length;
  const lateCount = attendanceRecords.filter(record => record.status === 'สาย').length;
  const totalCount = attendanceRecords.length;
  const presentPercentage = ((presentCount / totalCount) * 100).toFixed(2);
  const absentPercentage = ((absentCount / totalCount) * 100).toFixed(2);
  const leavePercentage = ((leaveCount / totalCount) * 100).toFixed(2);
  const latePercentage = ((lateCount / totalCount) * 100).toFixed(2);

  const now = new Date();
  const dateString = formatThaiDate(now);

  // take period + note from first record
  const period = attendanceRecords[0].period || '';
  const note   = attendanceRecords[0].note || '';

const flexMessage = {
  type: 'flex',
  altText: 'Attendance Summary',
  contents: {
    type: 'bubble',
    size: 'giga',
    // add hero if image exists
    ...(uploadedImageUrl ? {
      hero: {
        type: 'image',
        url: uploadedImageUrl,
        size: 'full',
        aspectRatio: '16:9',
        aspectMode: 'cover',
        action: {                 
          type: 'uri',
          uri: uploadedImageUrl
        }
      }
    } : {}),
    body: {
      type: 'box',
      layout: 'vertical',
      contents: [
        {
          type: 'text',
          text: `สรุปการมาเรียน ม.5/13`,
          weight: 'bold',
          size: 'xl',
          color: '#1DB446',
          margin: 'md'
        },
        {
          type: 'text',
          text: `วันที่ ${dateString}`,
          size: 'md',
          color: '#888888'
        },
        ...(period ? [{
          type: 'text',
          text: period,
          size: 'md',
          color: '#444444',
          margin: 'sm'
        }] : []),
        {
          type: 'separator',
          margin: 'md'
        },
        {
          type: 'box',
          layout: 'vertical',
          margin: 'md',
          spacing: 'sm',
          contents: attendanceRecords.map(record => ({
            type: 'box',
            layout: 'horizontal',
            contents: [
              {
                type: 'text',
                text: record.name,
                size: 'md',
                color: '#555555',
                flex: 4
              },
              {
                type: 'text',
                text: record.status,
                size: 'md',
                color: record.status === 'มา'
                  ? '#1DB446'
                  : (record.status === 'ขาด'
                      ? '#FF5555'
                      : (record.status === 'ลา'
                          ? '#FFC107'
                          : '#FF8800')),
                flex: 2,
                align: 'end'
              }
            ]
          }))
        },
        {
          type: 'separator',
          margin: 'md'
        },
        {
          type: 'box',
          layout: 'vertical',
          margin: 'md',
          contents: [
            {
              type: 'box',
              layout: 'horizontal',
              contents: [
                { type: 'text', text: 'มาเรียน:', size: 'md', color: '#1DB446', flex: 3 },
                { type: 'text', text: `${presentCount} คน (${presentPercentage}%)`, size: 'md', color: '#1DB446', flex: 2, align: 'end' }
              ]
            },
            {
              type: 'box',
              layout: 'horizontal',
              contents: [
                { type: 'text', text: 'ขาดเรียน:', size: 'md', color: '#FF5555', flex: 3 },
                { type: 'text', text: `${absentCount} คน (${absentPercentage}%)`, size: 'md', color: '#FF5555', flex: 2, align: 'end' }
              ]
            },
            {
              type: 'box',
              layout: 'horizontal',
              contents: [
                { type: 'text', text: 'ลา:', size: 'md', color: '#FFC107', flex: 3 },
                { type: 'text', text: `${leaveCount} คน (${leavePercentage}%)`, size: 'md', color: '#FFC107', flex: 2, align: 'end' }
              ]
            },
            {
              type: 'box',
              layout: 'horizontal',
              contents: [
                { type: 'text', text: 'สาย:', size: 'sm', color: '#FF8800', flex: 3 },
                { type: 'text', text: `${lateCount} คน (${latePercentage}%)`, size: 'sm', color: '#FF8800', flex: 2, align: 'end' }
              ]
            }
          ]
        },
        {
          type: 'separator',
          margin: 'md'
        },
        ...(note ? [{
          type: 'box',
          layout: 'vertical',
          margin: 'md',
          contents: [
            {
              type: 'text',
              text: `หมายเหตุ: \n${note}`,
              wrap: true,
              size: 'sm',
              color: '#555555'
            }
          ]
        }] : [])
      ]
    },
    styles: {
      footer: {
        separator: true
      }
    }
  }
};


  liff.shareTargetPicker([flexMessage])
    .then((result) => {
      if (result) {
        Swal.fire('Success', 'Attendance summary shared successfully!', 'success');
      } else {
        Swal.fire('Info', 'ShareTargetPicker was closed without sending the message', 'info');
      }
      liff.closeWindow();
    })
    .catch((error) => {
      console.error('Error sharing attendance summary: ', error);
      Swal.fire('Error', 'Error sharing attendance summary: ' + error, 'error');
    });
}


  </script>

  <footer class="text-center text-lg-start bg-light text-muted" style="position: static; left: 0; bottom: 0; width: 100%;">
    <div class="footer-container"></div>
  </footer>
</body>
</html>
